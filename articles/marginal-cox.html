<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marginal modelling of clustered survival data • mets</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Marginal modelling of clustered survival data">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mets</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.3.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/basic-dutils.html">dUtility data-frame manipulations</a>
    </li>
    <li>
      <a href="../articles/binomial-family.html">Analysis of multivariate binomial data: family analysis</a>
    </li>
    <li>
      <a href="../articles/binomial-twin.html">Analysis of bivariate binomial data: Twin analysis</a>
    </li>
    <li>
      <a href="../articles/binreg-ate.html">Average treatment effect (ATE) for Competing risks and binary outcomes</a>
    </li>
    <li>
      <a href="../articles/binreg-TRS.html">Two-Stage Randomization for for Competing risks and Survival outcomes</a>
    </li>
    <li>
      <a href="../articles/binreg.html">Binomial Regression for Survival and Competing Risks Data</a>
    </li>
    <li>
      <a href="../articles/cifreg.html">Cumulative Incidence Regression</a>
    </li>
    <li>
      <a href="../articles/cooking-survival-data.html">WIP: Cooking survival data, 5 minute recipes</a>
    </li>
    <li>
      <a href="../articles/glm-utility.html">GEE cluster standard errors and predictions for glm objects</a>
    </li>
    <li>
      <a href="../articles/haplo-discrete-ttp.html">Haplotype Discrete Survival Models</a>
    </li>
    <li>
      <a href="../articles/interval-discrete-survival.html">Discrete Interval Censored Survival Models</a>
    </li>
    <li>
      <a href="../articles/marginal-cox.html">Marginal modelling of clustered survival data</a>
    </li>
    <li>
      <a href="../articles/mediation-survival.html">Mediation Analysis for survival data</a>
    </li>
    <li>
      <a href="../articles/phreg_rct.html">Randomization for Cox Type rate models </a>
    </li>
    <li>
      <a href="../articles/quantitative-twin.html">Twin models</a>
    </li>
    <li>
      <a href="../articles/recurrent-events.html">Recurrent events</a>
    </li>
    <li>
      <a href="../articles/rmst-ate.html">Average treatment effect (ATE) for Restricted mean survival and years lost of Competing risks</a>
    </li>
    <li>
      <a href="../articles/survival-ate.html">G-Computation or standardization for the Cox, Fine-Gray and binomial regression models for survival data</a>
    </li>
    <li>
      <a href="../articles/time-to-event-family-studies-arev.html">A practical guide to Human Genetics with Lifetime Data</a>
    </li>
    <li>
      <a href="../articles/twostage-survival.html">Analysis of multivariate survival data</a>
    </li>
    <li>
      <a href="../articles/while-alive.html">While Alive estimands for Recurrent Events</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kkholst/mets/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Marginal modelling of clustered survival
data</h1>
                        <h4 data-toc-skip class="author">Klaus Holst
&amp; Thomas Scheike</h4>
            
            <h4 data-toc-skip class="date">2025-10-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/kkholst/mets/blob/main/vignettes/marginal-cox.Rmd" class="external-link"><code>vignettes/marginal-cox.Rmd</code></a></small>
      <div class="hidden name"><code>marginal-cox.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>A basic component for our modelling of multivariate survival data is
that many models are build around marginals that on Cox form. The
marginal Cox model can be fitted efficiently in the mets package, in
particular the handling of strata and robust standard errors is
optimized.</p>
<p>The basic models assumes that each subject has a marginal on Cox-form
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo>,</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>T</mi></msubsup><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex"> 
\lambda_{g(k,i)}(t) \exp( X_{ki}^T \beta).
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo>,</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">g(k,i)</annotation></semantics></math>
gives the strata for the subject.</p>
<p>We here discuss and show how to get robust standard errors of</p>
<ul>
<li><p>the regression parameters</p></li>
<li><p>the baseline</p></li>
</ul>
<p>and how to do goodness of fit test using</p>
<ul>
<li>cumulative residuals score test</li>
</ul>
<p>First we generate some data from the Clayton-Oakes model, with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>
members in each cluster and a variance parameter at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kkholst.github.io/mets/" class="external-link">mets</a></span><span class="op">)</span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>warn<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span> <span class="co"># to control output in simulatins for p-values below.</span></span>
<span> <span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span> <span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span> <span class="va">theta</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span> <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simClaytonOakes.html">simClaytonOakes</a></span><span class="op">(</span><span class="va">n</span>,<span class="va">k</span>,<span class="va">theta</span>,<span class="fl">0.3</span>,<span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>The data is on has one subject per row.</p>
<ul>
<li>time : time of event</li>
<li>status : 1 for event and 0 for censoring</li>
<li>x : x is a binary covariate</li>
<li>cluster : cluster</li>
</ul>
<p>Now we fit the model and produce robust standard errors for both
regression parameters and baseline.</p>
<p>First, recall that the baseline for strata
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
is asymptotically equivalent to
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mover><mi>A</mi><mo accent="true">̂</mo></mover><mi>g</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msub><mi>A</mi><mi>g</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><munder><mo>∑</mo><mrow><mi>k</mi><mo>∈</mo><mi>g</mi></mrow></munder><mrow><mo stretchy="true" form="prefix">(</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo>:</mo><mi>k</mi><mi>i</mi><mo>∈</mo><mi>g</mi></mrow></munder><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mfrac><mn>1</mn><msub><mi>S</mi><mrow><mn>0</mn><mo>,</mo><mi>g</mi></mrow></msub></mfrac><mi>d</mi><msubsup><mi>M</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>g</mi></msubsup><mo>−</mo><msup><mi>P</mi><mi>g</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>β</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\hat A_g(t) - A_g(t)  &amp; = \sum_{k \in g} \left( \sum_{i: ki \in g} \int_0^t \frac{1}{S_{0,g}} dM_{ki}^g  - P^g(t) \beta_k \right) 
\end{align}</annotation></semantics></math> with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>P</mi><mi>g</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><msub><mi>E</mi><mi>g</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mover><mi>Λ</mi><mo accent="true">̂</mo></mover><mi>g</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P^g(t) = \int_0^t E_g(s) d \hat \Lambda_g(s)</annotation></semantics></math>
the derivative of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mn>1</mn><mi>/</mi><msub><mi>S</mi><mrow><mn>0</mn><mo>,</mo><mi>g</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>N</mi><mrow><mo>⋅</mo><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\int_0^t 1/S_{0,g}(s) dN_{\cdot g}</annotation></semantics></math>
wrt to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>,
and
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mover><mi>β</mi><mo accent="true">̂</mo></mover><mo>−</mo><mi>β</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>I</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><munder><mo>∑</mo><mi>k</mi></munder><mrow><mo stretchy="true" form="prefix">(</mo><munder><mo>∑</mo><mi>i</mi></munder><msubsup><mo>∫</mo><mn>0</mn><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>E</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msubsup><mi>M</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>g</mi></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munder><mo>∑</mo><mi>k</mi></munder><msub><mi>β</mi><mi>k</mi></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\hat \beta  - \beta  &amp; = I(\tau)^{-1} \sum_k ( \sum_i \int_0^\tau (Z_{ki} - E_{g}) dM_{ki}^g ) =  \sum_k \beta_{k} 
\end{align}</annotation></semantics></math> with
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>M</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>g</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>N</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><msub><mi>Y</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>Λ</mi><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo>,</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>β</mi><mi>k</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>I</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><munder><mo>∑</mo><mi>i</mi></munder><msubsup><mo>∫</mo><mn>0</mn><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>E</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msubsup><mi>M</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>g</mi></msubsup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
 M_{ki}^g(t) &amp;  = N_{ki}(t) - \int_0^t Y_{ki}(s) \exp( Z_{ki} \beta) d \Lambda_{g(k,i)}(t), \\
 \beta_{k} &amp; =  I(\tau)^{-1} \sum_i \int_0^\tau (Z_{ki} - E_{g}) dM_{ki}^g 
\end{align}</annotation></semantics></math> the basic 0-mean processes,
that are martingales in the iid setting, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">I(t)</annotation></semantics></math>
is the derivative of the total score,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>U</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\hat U(t,\beta))</annotation></semantics></math>,
with respect to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
evaluated at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.</p>
<p>The variance of the baseline of strata g is estimated by
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><munder><mo>∑</mo><mrow><mi>k</mi><mo>∈</mo><mi>g</mi></mrow></munder><msup><mrow><mo stretchy="true" form="prefix">(</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo>:</mo><mi>k</mi><mi>i</mi><mo>∈</mo><mi>g</mi></mrow></munder><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mfrac><mn>1</mn><msub><mi>S</mi><mrow><mn>0</mn><mo>,</mo><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo>,</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msub></mfrac><mi>d</mi><msubsup><mover><mi>M</mi><mo accent="true">̂</mo></mover><mrow><mi>k</mi><mi>i</mi></mrow><mi>g</mi></msubsup><mo>−</mo><msup><mi>P</mi><mi>g</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>β</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\sum_{k \in g} ( \sum_{i: ki \in g} \int_0^t \frac{1}{S_{0,g(k,i)}} d\hat M_{ki}^g - P^g(t) \beta_k )^2
\end{align}</annotation></semantics></math> that can be computed using
the particular structure of
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>d</mi><msubsup><mover><mi>M</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mi>k</mi></mrow><mi>g</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>d</mi><msub><mi>N</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mfrac><mn>1</mn><msub><mi>S</mi><mrow><mn>0</mn><mo>,</mo><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msub></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>N</mi><mrow><mi>g</mi><mi>.</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
d \hat M_{ik}^g(t) &amp; =  dN_{ik}(t) -  \frac{1}{S_{0,g(i,k)}} \exp(Z_{ik} \beta) dN_{g.}(t) 
\end{align}</annotation></semantics></math></p>
<p>This robust variance of the baseline and the iid decomposition for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
is computed in mets as:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>   <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phreg.html">phreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>,<span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">x</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     n events</span></span>
<span><span class="co">#&gt;  5000   4854</span></span>
<span><span class="co">#&gt; coeffients:</span></span>
<span><span class="co">#&gt;   Estimate     S.E.  dU^-1/2 P-value</span></span>
<span><span class="co">#&gt; x 0.287859 0.028177 0.028897       0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; exp(coeffients):</span></span>
<span><span class="co">#&gt;   Estimate   2.5%  97.5%</span></span>
<span><span class="co">#&gt; x   1.3336 1.2619 1.4093</span></span>
<span>   <span class="co"># robust standard errors attached to output</span></span>
<span>   <span class="va">rob</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phreg.html">robust.phreg</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span></code></pre></div>
<p>We can get the iid decomposition of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>β</mi><mo accent="true">̂</mo></mover><mo>−</mo><mi>β</mi></mrow><annotation encoding="application/x-tex">\hat \beta - \beta</annotation></semantics></math>
by</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>   <span class="co"># making iid decomposition of regression parameters</span></span>
<span>   <span class="va">betaiid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kkholst.github.io/lava/reference/IC.html" class="external-link">IC</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">betaiid</span><span class="op">)</span></span>
<span><span class="co">#&gt;             x</span></span>
<span><span class="co">#&gt; 1 -0.34616008</span></span>
<span><span class="co">#&gt; 2 -1.44918926</span></span>
<span><span class="co">#&gt; 3 -0.03898156</span></span>
<span><span class="co">#&gt; 4  0.42156050</span></span>
<span><span class="co">#&gt; 5  0.34253904</span></span>
<span><span class="co">#&gt; 6 -0.07706668</span></span>
<span>   <span class="co"># robust standard errors</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">betaiid</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">betaiid</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">.5</span></span>
<span><span class="co">#&gt;            x</span></span>
<span><span class="co">#&gt; x 0.02817714</span></span>
<span>   <span class="co"># same as </span></span></code></pre></div>
<p>We now look at the plot with robust standard errors</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rob</span>,se<span class="op">=</span><span class="cn">TRUE</span>,robust<span class="op">=</span><span class="cn">TRUE</span>,col<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="marginal-cox_files/figure-html/unnamed-chunk-5-1.png" width="600px"></p>
<p>We can also make survival prediction with robust standard errors
using the phreg.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">pp</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/mlogit.html">predict</a></span><span class="op">(</span><span class="va">out</span>,<span class="va">data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>,<span class="op">]</span>,se<span class="op">=</span><span class="cn">TRUE</span>,robust<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pp</span>,se<span class="op">=</span><span class="cn">TRUE</span>,whichx<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p><img src="marginal-cox_files/figure-html/unnamed-chunk-6-1.png" width="600px"></p>
<p>Finally, just to check that we can recover the model we also estimate
the dependence parameter</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/twostageMLE.html">twostageMLE</a></span><span class="op">(</span><span class="va">out</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">tt</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dependence parameter for Clayton-Oakes model</span></span>
<span><span class="co">#&gt; Variance of Gamma distributed random effects</span></span>
<span><span class="co">#&gt; $estimates</span></span>
<span><span class="co">#&gt;                 Coef.         SE        z P-val Kendall tau        SE</span></span>
<span><span class="co">#&gt; dependence1 0.5316753 0.03497789 15.20032     0   0.2100093 0.0109146</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $type</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "summary.mets.twostage"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="goodness-of-fit">Goodness of fit<a class="anchor" aria-label="anchor" href="#goodness-of-fit"></a>
</h2>
<p>The observed score process is given by
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mover><mi>β</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><munder><mo>∑</mo><mi>k</mi></munder><munder><mo>∑</mo><mi>i</mi></munder><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mover><mi>E</mi><mo accent="true">̂</mo></mover><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msubsup><mover><mi>M</mi><mo accent="true">̂</mo></mover><mrow><mi>k</mi><mi>i</mi></mrow><mi>g</mi></msubsup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
U(t,\hat \beta) &amp; = \sum_k \sum_i \int_0^t (Z_{ki} - \hat E_g ) d \hat M_{ki}^g 
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
is strata
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo>,</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">g(k,i)</annotation></semantics></math>.
The observed score has the iid decomposition
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mover><mi>U</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munder><mo>∑</mo><mi>k</mi></munder><munder><mo>∑</mo><mi>i</mi></munder><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>E</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msubsup><mi>M</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>g</mi></msubsup><mo>−</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><munder><mo>∑</mo><mi>k</mi></munder><msub><mi>β</mi><mi>k</mi></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\hat U(t) = \sum_k \sum_i  \int_0^t (Z_{ki} - E_g) dM_{ki}^g  - 
    I(t)  \sum_k \beta_k 
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mi>k</mi></msub><annotation encoding="application/x-tex">\beta_k</annotation></semantics></math>
is the iid decomposition of the score process for the true
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>β</mi><mi>k</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>I</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><munder><mo>∑</mo><mi>i</mi></munder><msubsup><mo>∫</mo><mn>0</mn><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>E</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msubsup><mi>M</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>g</mi></msubsup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\beta_k  &amp; =  I(\tau)^{-1} \sum_i \int_0^\tau (Z_{ki} - E_g ) d  M_{ki}^g 
\end{align}</annotation></semantics></math> and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">I(t)</annotation></semantics></math>
is the derivative of the total score,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>U</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\hat U(t,\beta))</annotation></semantics></math>,
with respect to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
evaluated at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.</p>
<p>This observed score can be resampled given it is on iid form in terms
of clusters.</p>
<p>Now using the cumulative score process for checking proportional
hazards</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kkholst.github.io/lava/reference/gof.html" class="external-link">gof</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="va">gout</span></span>
<span><span class="co">#&gt; Cumulative score process test for Proportionality:</span></span>
<span><span class="co">#&gt;   Sup|U(t)|  pval</span></span>
<span><span class="co">#&gt; x  30.24353 0.401</span></span></code></pre></div>
<p>The p-value reflects wheter the observed score process is consistent
with the model.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gout</span><span class="op">)</span></span></code></pre></div>
<p><img src="marginal-cox_files/figure-html/unnamed-chunk-9-1.png" width="600px"></p>
<div class="section level3">
<h3 id="computational-aspects">Computational aspects<a class="anchor" aria-label="anchor" href="#computational-aspects"></a>
</h3>
<p>The score processes can be resampled as in Lin, Wei, Ying (1993)
using the martingale structure, such that the observed score process is
resampled by
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><munder><mo>∑</mo><mi>k</mi></munder><munder><mo>∑</mo><mi>i</mi></munder><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><msub><mi>g</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>E</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>N</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>I</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>g</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><msubsup><mo>∫</mo><mn>0</mn><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>E</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>N</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
  \sum_k \sum_i \int_0^t g_{ki} (Z_{ki} - E_g) dN_{ki}  - I(t)  I^{-1}(\tau) g_{ki} \int_0^{\tau} (Z_{ki} - E_g) dN_{ki} .
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">g_{ki}</annotation></semantics></math>
are i.i.d. standard normals.</p>
<p>Based on the zero mean processes we more generally with clusters can
resample the score process. For resampling of score process we need
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><munder><mo>∑</mo><mi>k</mi></munder><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>g</mi><mi>k</mi></msub><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>E</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msubsup><mi>M</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>g</mi></msubsup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
U(t,\beta) &amp; = \sum_k \sum_i g_k \int_0^t (Z_{ki} - E_g ) dM_{ki}^g 
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
is strata. We write
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mi>k</mi></msub><annotation encoding="application/x-tex">g_k</annotation></semantics></math>
as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">g_{ki}</annotation></semantics></math>
and thus repeating
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mi>k</mi></msub><annotation encoding="application/x-tex">g_k</annotation></semantics></math>
within each cluster.</p>
<p>Computations are done using that
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>E</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msubsup><mi>M</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>g</mi></msubsup></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>E</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msubsup><mi>N</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>g</mi></msubsup><mo>−</mo><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>E</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>Y</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msup><mi>Λ</mi><mi>g</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
\int_0^t (Z_{ki} - E_{g}) dM_{ki}^g &amp; = \int_0^t (Z_{ki} - E_{g}) dN_{ki}^g - \int_0^{t} (Z_{ki} - E_{g})  Y_{ki}(u) d\Lambda^g(u)  
\end{align*}</annotation></semantics></math> therefore and summing the
compensator part with the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">g_{ki}</annotation></semantics></math>
multipliers then gives for each strata
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mfrac><mrow><msubsup><mi>S</mi><mrow><mn>1</mn><mi>g</mi></mrow><mi>w</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><msub><mi>S</mi><mrow><mn>0</mn><mi>g</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mi>d</mi><msub><mi>N</mi><mrow><mi>g</mi><mi>.</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><msub><mi>E</mi><mi>g</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><msubsup><mi>S</mi><mrow><mn>0</mn><mi>g</mi></mrow><mi>w</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><msub><mi>S</mi><mrow><mn>0</mn><mi>g</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mi>d</mi><msub><mi>N</mi><mrow><mi>g</mi><mi>.</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
   &amp;  \int_0^t \frac{S_{1g}^w(u)}{S_{0g}(u)} dN_{g.}(v) -  \int_0^t E_{g}(u) \frac{S_{0g}^w(u)}{S_{0g}(u)} dN_{g.}(v)
\end{align*}</annotation></semantics></math> with<br><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>S</mi><mrow><mi>j</mi><mi>g</mi></mrow><mi>w</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><munder><mo>∑</mo><mrow><mi>k</mi><mi>i</mi><mo>∈</mo><mi>g</mi></mrow></munder><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>j</mi></msubsup><msub><mi>Y</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>g</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>S</mi><mrow><mi>j</mi><mi>g</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><munder><mo>∑</mo><mrow><mi>k</mi><mi>i</mi><mo>∈</mo><mi>g</mi></mrow></munder><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>Z</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>j</mi></msubsup><msub><mi>Y</mi><mrow><mi>k</mi><mi>i</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
S_{jg}^w(t) &amp; =  \sum_{ki \in g} \exp(Z_{ki} \beta) Z_{ki}^j Y_{ki}(t) g_{ki}  \\
S_{jg}(t) &amp; =  \sum_{ki \in g} \exp(Z_{ki} \beta) Z_{ki}^j Y_{ki}(t).
\end{align*}</annotation></semantics></math></p>
</div>
</div>
<div class="section level2">
<h2 id="cluster-stratified-cox-models">Cluster stratified Cox models<a class="anchor" aria-label="anchor" href="#cluster-stratified-cox-models"></a>
</h2>
<p>For clustered data it is possible to estimate the regression
coefficient within clusters by using Cox’s partial likelihood stratified
on clusters.</p>
<p>Note, here that the data is generated with a different subject
specific structure, so we will not recover the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
at 0.3 and the model will not be a proportional Cox model, we we would
also expect to reject “proportionality” with the gof-test.</p>
<p>The model can be thought of as
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo>,</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mrow><mi>k</mi><mi>i</mi></mrow><mi>T</mi></msubsup><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex"> 
\lambda_{g(k,i)} (t) \exp( X_{ki}^T \beta)
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>g</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_g(t)</annotation></semantics></math>
is some cluster specific baseline.</p>
<p>The regression coefficient
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
can be estimated by using the partial likelihood for clusters.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phreg.html">phreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>,<span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">x</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/strata.html" class="external-link">strata</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     n events</span></span>
<span><span class="co">#&gt;  5000   4854</span></span>
<span><span class="co">#&gt; coeffients:</span></span>
<span><span class="co">#&gt;   Estimate     S.E.  dU^-1/2 P-value</span></span>
<span><span class="co">#&gt; x 0.406307 0.032925 0.039226       0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; exp(coeffients):</span></span>
<span><span class="co">#&gt;   Estimate   2.5%  97.5%</span></span>
<span><span class="co">#&gt; x   1.5013 1.4074 1.6013</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sessioninfo">SessionInfo<a class="anchor" aria-label="anchor" href="#sessioninfo"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.5.1 (2025-06-13)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 24.04.3 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] mets_1.3.8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] cli_3.6.5           knitr_1.50          rlang_1.1.6        </span></span>
<span><span class="co">#&gt;  [4] xfun_0.53           textshaping_1.0.4   jsonlite_2.0.0     </span></span>
<span><span class="co">#&gt;  [7] listenv_0.9.1       future.apply_1.20.0 lava_1.8.1         </span></span>
<span><span class="co">#&gt; [10] htmltools_0.5.8.1   ragg_1.5.0          sass_0.4.10        </span></span>
<span><span class="co">#&gt; [13] rmarkdown_2.30      grid_4.5.1          evaluate_1.0.5     </span></span>
<span><span class="co">#&gt; [16] jquerylib_0.1.4     fastmap_1.2.0       numDeriv_2016.8-1.1</span></span>
<span><span class="co">#&gt; [19] yaml_2.3.10         mvtnorm_1.3-3       lifecycle_1.0.4    </span></span>
<span><span class="co">#&gt; [22] timereg_2.0.7       compiler_4.5.1      codetools_0.2-20   </span></span>
<span><span class="co">#&gt; [25] fs_1.6.6            htmlwidgets_1.6.4   Rcpp_1.1.0         </span></span>
<span><span class="co">#&gt; [28] future_1.67.0       lattice_0.22-7      systemfonts_1.3.1  </span></span>
<span><span class="co">#&gt; [31] digest_0.6.37       R6_2.6.1            parallelly_1.45.1  </span></span>
<span><span class="co">#&gt; [34] parallel_4.5.1      splines_4.5.1       Matrix_1.7-3       </span></span>
<span><span class="co">#&gt; [37] bslib_0.9.0         tools_4.5.1         globals_0.18.0     </span></span>
<span><span class="co">#&gt; [40] survival_3.8-3      pkgdown_2.1.3       cachem_1.1.0       </span></span>
<span><span class="co">#&gt; [43] desc_1.4.3</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Klaus K. Holst, Thomas Scheike.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
