<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Two-Stage Randomization for Cox Type rate models  • mets</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Two-Stage Randomization for Cox Type rate models ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mets</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.3.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/basic-dutils.html">dUtility data-frame manipulations</a>
    </li>
    <li>
      <a href="../articles/binomial-family.html">Analysis of multivariate binomial data: family analysis</a>
    </li>
    <li>
      <a href="../articles/binomial-twin.html">Analysis of bivariate binomial data: Twin analysis</a>
    </li>
    <li>
      <a href="../articles/binreg-ate.html">Average treatment effect (ATE) for Competing risks and binary outcomes</a>
    </li>
    <li>
      <a href="../articles/binreg-TRS.html">Two-Stage Randomization for for Competing risks and Survival outcomes</a>
    </li>
    <li>
      <a href="../articles/binreg.html">Binomial Regression for Survival and Competing Risks Data</a>
    </li>
    <li>
      <a href="../articles/cifreg.html">Cumulative Incidence Regression</a>
    </li>
    <li>
      <a href="../articles/cooking-survival-data.html">WIP: Cooking survival data, 5 minute recipes</a>
    </li>
    <li>
      <a href="../articles/glm-utility.html">GEE cluster standard errors and predictions for glm objects</a>
    </li>
    <li>
      <a href="../articles/haplo-discrete-ttp.html">Haplotype Discrete Survival Models</a>
    </li>
    <li>
      <a href="../articles/interval-discrete-survival.html">Discrete Interval Censored Survival Models</a>
    </li>
    <li>
      <a href="../articles/marginal-cox.html">Marginal modelling of clustered survival data</a>
    </li>
    <li>
      <a href="../articles/mediation-survival.html">Mediation Analysis for survival data</a>
    </li>
    <li>
      <a href="../articles/phreg_rct.html">Two-Stage Randomization for Cox Type rate models </a>
    </li>
    <li>
      <a href="../articles/quantitative-twin.html">Twin models</a>
    </li>
    <li>
      <a href="../articles/recurrent-events.html">Recurrent events</a>
    </li>
    <li>
      <a href="../articles/rmst-ate.html">Average treatment effect (ATE) for Restricted mean survival and years lost of Competing risks</a>
    </li>
    <li>
      <a href="../articles/survival-ate.html">G-Computation or standardization for the Cox, Fine-Gray and binomial regression models for survival data</a>
    </li>
    <li>
      <a href="../articles/time-to-event-family-studies-arev.html">A practical guide to Human Genetics with Lifetime Data</a>
    </li>
    <li>
      <a href="../articles/twostage-survival.html">Analysis of multivariate survival data</a>
    </li>
    <li>
      <a href="../articles/while-alive.html">While Alive estimands for Recurrent Events</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kkholst/mets/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Two-Stage Randomization for Cox Type rate
models</h1>
                        <h4 data-toc-skip class="author">Klaus Holst
&amp; Thomas Scheike</h4>
            
            <h4 data-toc-skip class="date">2025-01-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/kkholst/mets/blob/main/vignettes/phreg_rct.Rmd" class="external-link"><code>vignettes/phreg_rct.Rmd</code></a></small>
      <div class="hidden name"><code>phreg_rct.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="two-stage-randomization-for-counting-process-outcomes">Two-Stage Randomization for counting process outcomes<a class="anchor" aria-label="anchor" href="#two-stage-randomization-for-counting-process-outcomes"></a>
</h2>
<p>Specify rate models of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N_1(t)</annotation></semantics></math>.</p>
<ul>
<li>survival data</li>
<li>competing risks, cause specific hazards.</li>
<li>recurrent events data</li>
</ul>
<p>Under simple randomization we can estimate the rate Cox model</p>
<ul>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mn>0</mn></msub><msub><mi>β</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_0(t) \exp(A_0 \beta_0)</annotation></semantics></math></li>
</ul>
<p>Under two-stage randomization we can estimate the rate Cox model</p>
<ul>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mn>0</mn></msub><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>A</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>β</mi><mn>1</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_0(t) \exp(A_0 \beta_0 + A_1(t) \beta_1 )</annotation></semantics></math></li>
</ul>
<p>Starting point is that Cox’s partial likelihood score can be used for
estimating parameters
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>∫</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>N</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
   U(\beta) &amp; = \int (A(t) - e(t)) dN_1(t)
 \end{align*}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">A(t)</annotation></semantics></math>
is the combined treatments over time.</p>
<ul>
<li>the solution will converge to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>β</mi><mo>*</mo></msup><annotation encoding="application/x-tex">\beta^*</annotation></semantics></math>
the Struthers-Kalbfleisch solution of the score and will have robust
standard errors Lin-Wei.</li>
</ul>
<p>The estimator can be agumented in different ways using additional
covariates at the time of randomization and a censoring augmentation.
The solved estimating eqution is
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>U</mi><mi>i</mi></msub><mo>−</mo><mi>A</mi><mi>U</mi><msub><mi>G</mi><mn>0</mn></msub><mo>−</mo><mi>A</mi><mi>U</mi><msub><mi>G</mi><mn>1</mn></msub><mo>+</mo><mi>A</mi><mi>U</mi><msub><mi>G</mi><mi>C</mi></msub><mo>=</mo><mn>0</mn></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
 \sum_i   U_i - AUG_0 - AUG_1 + AUG_C   = 0 
 \end{align*}</annotation></semantics></math> using the covariates from
augmentR0 to augment with
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>A</mi><mi>U</mi><msub><mi>G</mi><mn>0</mn></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mn>0</mn></msub><mo>−</mo><msub><mi>π</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>X</mi><mn>0</mn></msub><msub><mi>γ</mi><mn>0</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
 AUG_0 = ( A_0 - \pi_0(X_0) ) X_0 \gamma_0
 \end{align*}</annotation></semantics></math> where possibly
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mn>0</mn></msub><mo>=</mo><mn>1</mn><mo stretchy="false" form="prefix">|</mo><msub><mi>X</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>π</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(A_0=1|X_0)=\pi_0(X_0)</annotation></semantics></math>
but does not depend on covariates under randomization, and furhter using
the covariates from augmentR1, to augment with R indiciating that the
randomization takes place or not,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>A</mi><mi>U</mi><msub><mi>G</mi><mn>1</mn></msub><mo>=</mo><mi>R</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mn>1</mn></msub><mo>−</mo><msub><mi>π</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mn>1</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>X</mi><mn>1</mn></msub><msub><mi>γ</mi><mn>1</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
 AUG_1 = R ( A_1 - \pi_1(X_1))  X_1 \gamma_1
 \end{align*}</annotation></semantics></math> and the dynamic censoring
augmenting<br><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>A</mi><mi>U</mi><msub><mi>G</mi><mi>C</mi></msub><mo>=</mo><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><msub><mi>γ</mi><mi>c</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>T</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mover><mi>e</mi><mo accent="true">‾</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mn>1</mn><mrow><msub><mi>G</mi><mi>c</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mi>d</mi><msub><mi>M</mi><mi>c</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
  AUG_C =  \int_0^t \gamma_c(s)^T (e(s) - \bar e(s))  \frac{1}{G_c(s) } dM_c(s) 
 \end{align*}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>γ</mi><mi>c</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\gamma_c(s)</annotation></semantics></math>
is chosen to minimize the variance given the dynamic covariates
specified by augmentC.</p>
<p>The propensity score models are always estimated unless it is
requested to use some fixed number
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mn>0</mn></msub><mo>=</mo><mn>1</mn><mi>/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">\pi_0=1/2</annotation></semantics></math>
for example, but always better to be adaptive and estimate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>π</mi><mn>0</mn></msub><annotation encoding="application/x-tex">\pi_0</annotation></semantics></math>.
Also
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mn>0</mn></msub><annotation encoding="application/x-tex">\gamma_0</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mn>1</mn></msub><annotation encoding="application/x-tex">\gamma_1</annotation></semantics></math>
are estimated to reduce variance of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>U</mi><mi>i</mi></msub><annotation encoding="application/x-tex">U_i</annotation></semantics></math>.</p>
<ul>
<li>The treatment’s must be given as factors.</li>
<li>Treatment for 2nd randomization may depend on response.
<ul>
<li>Treatment probabilities are estimated by default and uncertainty
from this adjusted for.</li>
<li>treat.model must then typically allow for interaction with treatment
number and covariates</li>
</ul>
</li>
<li>Randomization augmentation for 1’st and 2’nd randomization possible.
<ul>
<li>typesR=c(“R0”,“R1”,“R01”)</li>
</ul>
</li>
<li>Censoring model possibly stratified on observed covariates (at time
0).
<ul>
<li>default model is to stratify after randomization R0</li>
<li>cens.model can be specified</li>
</ul>
</li>
<li>Censoring augmentation done dynamically over time with
time-dependent covariates.
<ul>
<li>typesC=c(“C”,“dynC”), C fixed coefficients and dynC dynamic</li>
<li>done for each strata in censoring model</li>
</ul>
</li>
</ul>
<p>Standard errors are estimated using the influence function of all
estimators and tests of differences can therefore be computed
subsequently.</p>
<ul>
<li>variance adjustment for censoring augmentation computed subtracting
variance gain</li>
<li>influence functions given for case with R0 only</li>
</ul>
<p>The times of randomization is specified by</p>
<ul>
<li>treat.var is “1” when a randomization is given
<ul>
<li>default is to assume that all time-points corresponds to a
treatment, the survival case without time-dependent covariates</li>
<li>recurrent events situation must be specified as first record of each
subject, see below example.</li>
</ul>
</li>
</ul>
<p>Data must be given on start,stop,status survival format with</p>
<ul>
<li>one code of status indicating events of interest</li>
<li>one code for the censorings</li>
</ul>
<p>The phreg_rct can be used for counting process style data, and thus
covers situations with</p>
<ul>
<li>recurrent events</li>
<li>survival data</li>
<li>cause-specific hazards (competing risks)</li>
</ul>
<p>and will in all cases compute augmentations</p>
<ul>
<li>dynamic censoring augmentation
<ul>
<li>dynC</li>
</ul>
</li>
<li>RCT augmentation
<ul>
<li>R0, R1 and R01</li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="simple-randomization-lu-tsiatis-marginal-cox-model">Simple Randomization: Lu-Tsiatis marginal Cox model<a class="anchor" aria-label="anchor" href="#simple-randomization-lu-tsiatis-marginal-cox-model"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kkholst.github.io/mets/" class="external-link">mets</a></span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Lu, Tsiatis simulation</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">mets</span><span class="fu">:::</span><span class="fu">simLT</span><span class="op">(</span><span class="fl">0.7</span>,<span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/drelevel.html">dfactor</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">Z.f</span><span class="op">~</span><span class="va">Z</span></span>
<span> </span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phreg_rct.html">phreg_rct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>,<span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">Z.f</span>,data<span class="op">=</span><span class="va">data</span>,augmentR0<span class="op">=</span><span class="op">~</span><span class="va">X</span>,augmentC<span class="op">=</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span><span class="op">:</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 Estimate   Std.Err       2.5%     97.5%   P-value</span></span>
<span><span class="co">#&gt; Marginal-Z.f1 0.29263400 0.2739159 -0.2442313 0.8294993 0.2853693</span></span>
<span><span class="co">#&gt; R0_C:Z.f1     0.07166242 0.2234066 -0.3662065 0.5095313 0.7483838</span></span>
<span><span class="co">#&gt; R0_dynC:Z.f1  0.08321604 0.2221710 -0.3522312 0.5186633 0.7079889</span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "summary.phreg_rct"</span></span>
<span><span class="co">###out &lt;- phreg_rct(Surv(time,status)~Z.f,data=data,augmentR0=~X,augmentC=~X)</span></span>
<span><span class="co">###out &lt;- phreg_rct(Surv(time,status)~Z.f,data=data,augmentR0=~X,augmentC=~factor(Z):X,cens.model=~+1)</span></span></code></pre></div>
<p>Results consitent with speff of library(speff2trial)</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###library(speff2trial) </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kkholst.github.io/mets/" class="external-link">mets</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ACTG175</span><span class="op">)</span></span>
<span><span class="co">###</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">ACTG175</span><span class="op">[</span><span class="va">ACTG175</span><span class="op">$</span><span class="va">arms</span><span class="op">==</span><span class="fl">0</span> <span class="op">|</span> <span class="va">ACTG175</span><span class="op">$</span><span class="va">arms</span><span class="op">==</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"days"</span>,<span class="st">"cens"</span>,<span class="st">"arms"</span>,<span class="st">"strat"</span>,<span class="st">"cd40"</span>,<span class="st">"cd80"</span>,<span class="st">"age"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">days</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">days</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">0.01</span></span>
<span><span class="fu"><a href="../reference/drelevel.html">dfactor</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">arms.f</span><span class="op">~</span><span class="va">arms</span></span>
<span><span class="va">notrun</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">notrun</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span> <span class="op">{</span> </span>
<span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu">speffSurv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">days</span>,<span class="va">cens</span><span class="op">)</span><span class="op">~</span><span class="va">cd40</span><span class="op">+</span><span class="va">cd80</span><span class="op">+</span><span class="va">age</span>,data<span class="op">=</span><span class="va">data</span>,trt.id<span class="op">=</span><span class="st">"arms"</span>,fixed<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Treatment effect</span></span>
<span><span class="co">#             Log HR       SE   LowerCI   UpperCI           p</span></span>
<span><span class="co"># Prop Haz  -0.70375  0.12352  -0.94584  -0.46165  1.2162e-08</span></span>
<span><span class="co"># Speff     -0.72430  0.12051  -0.96050  -0.48810  1.8533e-09</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phreg_rct.html">phreg_rct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">days</span>,<span class="va">cens</span><span class="op">)</span><span class="op">~</span><span class="va">arms.f</span>,data<span class="op">=</span><span class="va">data</span>,augmentR0<span class="op">=</span><span class="op">~</span><span class="va">cd40</span><span class="op">+</span><span class="va">cd80</span><span class="op">+</span><span class="va">age</span>,augmentC<span class="op">=</span><span class="op">~</span><span class="va">cd40</span><span class="op">+</span><span class="va">cd80</span><span class="op">+</span><span class="va">age</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt;                    Estimate   Std.Err       2.5%      97.5%      P-value</span></span>
<span><span class="co">#&gt; Marginal-arms.f1 -0.7036460 0.1224406 -0.9436251 -0.4636669 9.092786e-09</span></span>
<span><span class="co">#&gt; R0_C:arms.f1     -0.7265342 0.1197607 -0.9612610 -0.4918075 1.306891e-09</span></span>
<span><span class="co">#&gt; R0_dynC:arms.f1  -0.7204699 0.1196158 -0.9549125 -0.4860272 1.710025e-09</span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "summary.phreg_rct"</span></span></code></pre></div>
<p>The study is actually block-randomized according (?) so the standard
should be computed with an adjustment that is equivalent to augmenting
with this block as factor</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dtable.html">dtable</a></span><span class="op">(</span><span class="va">data</span>,<span class="op">~</span><span class="va">strat</span><span class="op">+</span><span class="va">arms</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;       arms   0   1</span></span>
<span><span class="co">#&gt; strat             </span></span>
<span><span class="co">#&gt; 1          223 213</span></span>
<span><span class="co">#&gt; 2           96 106</span></span>
<span><span class="co">#&gt; 3          213 203</span></span>
<span><span class="fu"><a href="../reference/drelevel.html">dfactor</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">strat.f</span><span class="op">~</span><span class="va">strat</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phreg_rct.html">phreg_rct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">days</span>,<span class="va">cens</span><span class="op">)</span><span class="op">~</span><span class="va">arms.f</span>,data<span class="op">=</span><span class="va">data</span>,augmentR0<span class="op">=</span><span class="op">~</span><span class="va">strat.f</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt;                    Estimate   Std.Err       2.5%      97.5%      P-value</span></span>
<span><span class="co">#&gt; Marginal-arms.f1 -0.7036460 0.1224406 -0.9436251 -0.4636669 9.092786e-09</span></span>
<span><span class="co">#&gt; R0_none:arms.f1  -0.7009844 0.1217138 -0.9395390 -0.4624298 8.447051e-09</span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "summary.phreg_rct"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="recurrent-events-simple-randomization">Recurrent events: Simple Randomization<a class="anchor" aria-label="anchor" href="#recurrent-events-simple-randomization"></a>
</h2>
<p>Recurrents events simulation with death and censoring.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fl">0.15</span>; </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">base1cumhaz</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">base4cumhaz</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">drcumhaz</span><span class="op">)</span></span>
<span><span class="va">dr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recreg.html">scalecumhaz</a></span><span class="op">(</span><span class="va">drcumhaz</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">base1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recreg.html">scalecumhaz</a></span><span class="op">(</span><span class="va">base1cumhaz</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">base4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recreg.html">scalecumhaz</a></span><span class="op">(</span><span class="va">base4cumhaz</span>,<span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">cens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2000</span>,<span class="fl">0.5</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5110</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ce</span> <span class="op">&lt;-</span> <span class="fl">3</span>; <span class="va">betao1</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">varz</span> <span class="op">&lt;-</span> <span class="fl">1</span>; <span class="va">dep</span><span class="op">=</span><span class="fl">4</span>; <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span><span class="op">/</span><span class="va">varz</span><span class="op">)</span><span class="op">*</span><span class="va">varz</span></span>
<span><span class="va">Z0</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">px</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">betao1</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span> <span class="va">px</span> <span class="op">&lt;-</span> <span class="fu">lava</span><span class="fu">::</span><span class="fu"><a href="https://kkholst.github.io/lava/reference/internal.html" class="external-link">expit</a></span><span class="op">(</span><span class="va">betao1</span><span class="op">*</span><span class="va">X</span><span class="op">)</span>      </span>
<span><span class="va">A0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="va">px</span><span class="op">)</span></span>
<span><span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">A0</span><span class="op">*</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">rd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span> <span class="va">A0</span> <span class="op">*</span> <span class="fl">0.15</span><span class="op">)</span></span>
<span><span class="va">rc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span> <span class="va">A0</span> <span class="op">*</span> <span class="fl">0</span> <span class="op">)</span></span>
<span><span class="co">###</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span>    <span class="fu">mets</span><span class="fu">:::</span><span class="fu">simLUCox</span><span class="op">(</span><span class="va">n</span>,<span class="va">base1</span>,death.cumhaz<span class="op">=</span><span class="va">dr</span>,r1<span class="op">=</span><span class="va">r1</span>,Z0<span class="op">=</span><span class="va">X</span>,dependence<span class="op">=</span><span class="va">dep</span>,var.z<span class="op">=</span><span class="va">varz</span>,cens<span class="op">=</span><span class="va">ce</span><span class="op">/</span><span class="fl">5000</span><span class="op">)</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">A0</span> <span class="op">&lt;-</span> <span class="va">A0</span><span class="op">[</span><span class="va">rr</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">rr</span>,<span class="st">"z"</span><span class="op">)</span><span class="op">[</span><span class="va">rr</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">lz1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">rr</span><span class="op">$</span><span class="va">z1</span><span class="op">)</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">rr</span><span class="op">$</span><span class="va">lz1</span> </span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">lX</span> <span class="op">&lt;-</span> <span class="va">rr</span><span class="op">$</span><span class="va">z1</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">statusD</span> <span class="op">&lt;-</span> <span class="va">rr</span><span class="op">$</span><span class="va">status</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dtransform.html">dtransform</a></span><span class="op">(</span><span class="va">rr</span>,statusD<span class="op">=</span><span class="fl">2</span>,<span class="va">death</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/count.history.html">count.history</a></span><span class="op">(</span><span class="va">rr</span><span class="op">)</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">rr</span><span class="op">$</span><span class="va">A0</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">rr</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">Z.f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Z</span><span class="op">)</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">treattime</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dtransform.html">dtransform</a></span><span class="op">(</span><span class="va">data</span>,treattime<span class="op">=</span><span class="fl">1</span>,<span class="va">lbnr__id</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dprint.html">dlist</a></span><span class="op">(</span><span class="va">data</span>,<span class="va">start</span><span class="op">+</span><span class="va">stop</span><span class="op">+</span><span class="va">statusD</span><span class="op">+</span><span class="va">A0</span><span class="op">+</span><span class="va">z1</span><span class="op">+</span><span class="va">treattime</span><span class="op">+</span><span class="va">Count1</span><span class="op">~</span><span class="va">id</span><span class="op">|</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; id: 4</span></span>
<span><span class="co">#&gt;      start   stop    statusD A0 z1    treattime Count1</span></span>
<span><span class="co">#&gt; 4      0.000   9.565 1       0  0.471 1         0     </span></span>
<span><span class="co">#&gt; 1003   9.565 372.057 1       0  0.471 0         1     </span></span>
<span><span class="co">#&gt; 1468 372.057 389.831 0       0  0.471 0         2     </span></span>
<span><span class="co">#&gt; ------------------------------------------------------------ </span></span>
<span><span class="co">#&gt; id: 5</span></span>
<span><span class="co">#&gt;   start stop  statusD A0 z1    treattime Count1</span></span>
<span><span class="co">#&gt; 5 0     213.9 2       1  2.338 1         0</span></span></code></pre></div>
<p>Now we fit the model</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phreg_rct.html">phreg_rct</a></span><span class="op">(</span><span class="fu"><a href="../reference/Event.html">Event</a></span><span class="op">(</span><span class="va">start</span>,<span class="va">stop</span>,<span class="va">statusD</span><span class="op">)</span><span class="op">~</span><span class="va">Z.f</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,</span>
<span>     treat.var<span class="op">=</span><span class="st">"treattime"</span>,typesR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"non"</span>,<span class="st">"R0"</span><span class="op">)</span>,typesC<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"non"</span>,<span class="st">"C"</span>,<span class="st">"dynC"</span><span class="op">)</span>,</span>
<span>     augmentR0<span class="op">=</span><span class="op">~</span><span class="va">z1</span>,augmentC<span class="op">=</span><span class="op">~</span><span class="va">z1</span><span class="op">+</span><span class="va">Count1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span>
<span><span class="co">#&gt;                Estimate    Std.Err       2.5%     97.5%      P-value</span></span>
<span><span class="co">#&gt; Marginal-Z.f1 0.2870649 0.09632565 0.09827011 0.4758597 0.0028810700</span></span>
<span><span class="co">#&gt; non_C:Z.f1    0.2826049 0.09631924 0.09382262 0.4713871 0.0033457707</span></span>
<span><span class="co">#&gt; non_dynC:Z.f1 0.1926888 0.08864883 0.01894025 0.3664373 0.0297337758</span></span>
<span><span class="co">#&gt; R0_non:Z.f1   0.3110880 0.08049844 0.15331399 0.4688621 0.0001113067</span></span>
<span><span class="co">#&gt; R0_C:Z.f1     0.3066141 0.08049078 0.14885504 0.4643731 0.0001393570</span></span>
<span><span class="co">#&gt; R0_dynC:Z.f1  0.2164684 0.07113356 0.07704922 0.3558877 0.0023413376</span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "summary.phreg_rct"</span></span></code></pre></div>
<ul>
<li>Censoring model was stratified on Z.f</li>
<li>treatment probabilities were estimated using the data</li>
</ul>
</div>
<div class="section level2">
<h2 id="twostage-randomization-recurrent-events">Twostage Randomization: Recurrent events<a class="anchor" aria-label="anchor" href="#twostage-randomization-recurrent-events"></a>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">beta</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>,<span class="fl">0.3</span><span class="op">)</span>;<span class="va">betatr</span><span class="op">=</span><span class="fl">0.3</span>;<span class="va">betac</span><span class="op">=</span><span class="fl">0</span>;<span class="va">betao</span><span class="op">=</span><span class="fl">0</span>;<span class="va">betao1</span><span class="op">=</span><span class="fl">0</span>;<span class="va">ce</span><span class="op">=</span><span class="fl">3</span>;<span class="va">fixed</span><span class="op">=</span><span class="fl">1</span>;<span class="va">sim</span><span class="op">=</span><span class="fl">1</span>;<span class="va">dep</span><span class="op">=</span><span class="fl">4</span>;<span class="va">varz</span><span class="op">=</span><span class="fl">1</span>;<span class="va">ztr</span><span class="op">=</span><span class="fl">0</span>; <span class="va">ce</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="co">## take possible frailty </span></span>
<span><span class="va">Z0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span><span class="op">/</span><span class="va">varz</span><span class="op">)</span><span class="op">*</span><span class="va">varz</span></span>
<span><span class="va">px0</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>; <span class="kw">if</span> <span class="op">(</span><span class="va">betao</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span> <span class="va">px0</span> <span class="op">&lt;-</span> <span class="fu">expit</span><span class="op">(</span><span class="va">betao</span><span class="op">*</span><span class="va">Z0</span><span class="op">)</span></span>
<span><span class="va">A0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="va">px0</span><span class="op">)</span></span>
<span><span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">A0</span><span class="op">*</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#</span></span>
<span><span class="va">px1</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>; <span class="kw">if</span> <span class="op">(</span><span class="va">betao1</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span> <span class="va">px1</span> <span class="op">&lt;-</span> <span class="fu">expit</span><span class="op">(</span><span class="va">betao1</span><span class="op">*</span><span class="va">Z0</span><span class="op">)</span></span>
<span><span class="va">A1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="va">px1</span><span class="op">)</span></span>
<span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">A1</span><span class="op">*</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">rtr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">A0</span><span class="op">*</span><span class="va">betatr</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span>  <span class="fu">mets</span><span class="fu">:::</span><span class="fu">simLUCox</span><span class="op">(</span><span class="va">n</span>,<span class="va">base1</span>,death.cumhaz<span class="op">=</span><span class="va">dr</span>,cumhaz2<span class="op">=</span><span class="va">base1</span>,rtr<span class="op">=</span><span class="va">rtr</span>,betatr<span class="op">=</span><span class="fl">0.3</span>,A0<span class="op">=</span><span class="va">A0</span>,Z0<span class="op">=</span><span class="va">Z0</span>,</span>
<span>        r1<span class="op">=</span><span class="va">r1</span>,r2<span class="op">=</span><span class="va">r2</span>,dependence<span class="op">=</span><span class="va">dep</span>,var.z<span class="op">=</span><span class="va">varz</span>,cens<span class="op">=</span><span class="va">ce</span><span class="op">/</span><span class="fl">5000</span>,ztr<span class="op">=</span><span class="va">ztr</span><span class="op">)</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">rr</span>,<span class="st">"z"</span><span class="op">)</span><span class="op">[</span><span class="va">rr</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">A1</span> <span class="op">&lt;-</span> <span class="va">A1</span><span class="op">[</span><span class="va">rr</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">A0</span> <span class="op">&lt;-</span> <span class="va">A0</span><span class="op">[</span><span class="va">rr</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">lz1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">rr</span><span class="op">$</span><span class="va">z1</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/count.history.html">count.history</a></span><span class="op">(</span><span class="va">rr</span><span class="op">)</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">A1t</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dtransform.html">dtransform</a></span><span class="op">(</span><span class="va">rr</span>,A1t<span class="op">=</span><span class="va">A1</span>,<span class="va">Count2</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> </span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">At.f</span> <span class="op">&lt;-</span> <span class="va">rr</span><span class="op">$</span><span class="va">A0</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">A0.f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">rr</span><span class="op">$</span><span class="va">A0</span><span class="op">)</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">A1.f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">rr</span><span class="op">$</span><span class="va">A1</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dtransform.html">dtransform</a></span><span class="op">(</span><span class="va">rr</span>, At.f <span class="op">=</span> <span class="va">A1</span>, <span class="va">Count2</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">At.f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">rr</span><span class="op">$</span><span class="va">At.f</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/drelevel.html">dfactor</a></span><span class="op">(</span><span class="va">rr</span><span class="op">)</span>  <span class="op">&lt;-</span>  <span class="va">A0.f</span><span class="op">~</span><span class="va">A0</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">treattime</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dtransform.html">dtransform</a></span><span class="op">(</span><span class="va">rr</span>,treattime<span class="op">=</span><span class="fl">1</span>,<span class="va">lbnr__id</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="va">lagCount2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dlag.html">dlag</a></span><span class="op">(</span><span class="va">rr</span><span class="op">$</span><span class="va">Count2</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dtransform.html">dtransform</a></span><span class="op">(</span><span class="va">rr</span>,treattime<span class="op">=</span><span class="fl">1</span>,<span class="va">Count2</span><span class="op">==</span><span class="fl">1</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Count2</span><span class="op">!=</span><span class="va">lagCount2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dprint.html">dlist</a></span><span class="op">(</span><span class="va">rr</span>,<span class="va">start</span><span class="op">+</span><span class="va">stop</span><span class="op">+</span><span class="va">statusD</span><span class="op">+</span><span class="va">A0</span><span class="op">+</span><span class="va">A1</span><span class="op">+</span><span class="va">A1t</span><span class="op">+</span><span class="va">At.f</span><span class="op">+</span><span class="va">Count2</span><span class="op">+</span><span class="va">z1</span><span class="op">+</span><span class="va">treattime</span><span class="op">+</span><span class="va">Count1</span><span class="op">~</span><span class="va">id</span><span class="op">|</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; id: 5</span></span>
<span><span class="co">#&gt;   start stop  statusD A0 A1 A1t At.f Count2 z1     treattime Count1</span></span>
<span><span class="co">#&gt; 5 0     132.3 3       1  1  0   1    0      0.2316 1         0     </span></span>
<span><span class="co">#&gt; ------------------------------------------------------------ </span></span>
<span><span class="co">#&gt; id: 10</span></span>
<span><span class="co">#&gt;     start stop    statusD A0 A1 A1t At.f Count2 z1      treattime Count1</span></span>
<span><span class="co">#&gt; 10   0.00   33.12 2       1  0  0   1    0      0.06891 1         0     </span></span>
<span><span class="co">#&gt; 509 33.12 1363.53 0       1  0  0   0    1      0.06891 1         0</span></span></code></pre></div>
<p>Now fitting the model and computing different augmentations (true
values 0.3 and 0.3)</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phreg_rct.html">phreg_rct</a></span><span class="op">(</span><span class="fu"><a href="../reference/Event.html">Event</a></span><span class="op">(</span><span class="va">start</span>,<span class="va">time</span>,<span class="va">statusD</span><span class="op">)</span><span class="op">~</span><span class="va">A0.f</span><span class="op">+</span><span class="va">A1t</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>,data<span class="op">=</span><span class="va">rr</span>,</span>
<span>     typesR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"non"</span>,<span class="st">"R0"</span>,<span class="st">"R1"</span>,<span class="st">"R01"</span><span class="op">)</span>,typesC<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"non"</span>,<span class="st">"C"</span>,<span class="st">"dynC"</span><span class="op">)</span>,treat.var<span class="op">=</span><span class="st">"treattime"</span>,</span>
<span>     treat.model<span class="op">=</span><span class="va">At.f</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Count2</span><span class="op">)</span>,</span>
<span>     augmentR0<span class="op">=</span><span class="op">~</span><span class="va">z1</span>,augmentR1<span class="op">=</span><span class="op">~</span><span class="va">z1</span>,augmentC<span class="op">=</span><span class="op">~</span><span class="va">z1</span><span class="op">+</span><span class="va">Count1</span><span class="op">+</span><span class="va">A1t</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sse</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 Estimate   Std.Err        2.5%     97.5%      P-value</span></span>
<span><span class="co">#&gt; Marginal-A0.f1 0.3179631 0.1418023  0.04003574 0.5958904 0.0249420566</span></span>
<span><span class="co">#&gt; Marginal-A1t   0.3290147 0.1472363  0.04043683 0.6175925 0.0254434247</span></span>
<span><span class="co">#&gt; non_C:A0.f1    0.3002782 0.1391490  0.02755115 0.5730053 0.0309308283</span></span>
<span><span class="co">#&gt; non_C:A1t      0.4151190 0.1405664  0.13961382 0.6906241 0.0031451130</span></span>
<span><span class="co">#&gt; non_dynC:A0.f1 0.3104992 0.1314476  0.05286660 0.5681318 0.0181692114</span></span>
<span><span class="co">#&gt; non_dynC:A1t   0.4374223 0.1300991  0.18243265 0.6924119 0.0007731772</span></span>
<span><span class="co">#&gt; R0_non:A0.f1   0.4142867 0.1176773  0.18364338 0.6449300 0.0004306830</span></span>
<span><span class="co">#&gt; R0_non:A1t     0.3382185 0.1470378  0.05002979 0.6264072 0.0214360247</span></span>
<span><span class="co">#&gt; R0_C:A0.f1     0.3962505 0.1144662  0.17190089 0.6206002 0.0005367253</span></span>
<span><span class="co">#&gt; R0_C:A1t       0.4242165 0.1403584  0.14911904 0.6993140 0.0025079567</span></span>
<span><span class="co">#&gt; R0_dynC:A0.f1  0.4066624 0.1049692  0.20092652 0.6123983 0.0001070147</span></span>
<span><span class="co">#&gt; R0_dynC:A1t    0.4464941 0.1298744  0.19194497 0.7010432 0.0005862621</span></span>
<span><span class="co">#&gt; R1_non:A0.f1   0.3269008 0.1416813  0.04921043 0.6045911 0.0210383383</span></span>
<span><span class="co">#&gt; R1_non:A1t     0.2104421 0.1254571 -0.03544923 0.4563335 0.0934636201</span></span>
<span><span class="co">#&gt; R1_C:A0.f1     0.3092275 0.1390258  0.03674199 0.5817130 0.0261319083</span></span>
<span><span class="co">#&gt; R1_C:A1t       0.2976811 0.1175580  0.06727171 0.5280905 0.0113347106</span></span>
<span><span class="co">#&gt; R1_dynC:A0.f1  0.3194771 0.1313171  0.06210024 0.5768540 0.0149798139</span></span>
<span><span class="co">#&gt; R1_dynC:A1t    0.3202318 0.1048176  0.11479297 0.5256706 0.0022496121</span></span>
<span><span class="co">#&gt; R01_non:A0.f1  0.4092668 0.1176428  0.17869115 0.6398424 0.0005034879</span></span>
<span><span class="co">#&gt; R01_non:A1t    0.2280764 0.1243165 -0.01557936 0.4717322 0.0665584775</span></span>
<span><span class="co">#&gt; R01_C:A0.f1    0.3912859 0.1144307  0.16700576 0.6155659 0.0006275647</span></span>
<span><span class="co">#&gt; R01_C:A1t      0.3150865 0.1163399  0.08706445 0.5431086 0.0067623432</span></span>
<span><span class="co">#&gt; R01_dynC:A0.f1 0.4016977 0.1049305  0.19603760 0.6073577 0.0001290708</span></span>
<span><span class="co">#&gt; R01_dynC:A1t   0.3375831 0.1034497  0.13482542 0.5403408 0.0011013908</span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "summary.phreg_rct"</span></span></code></pre></div>
<ul>
<li>treat.model has A0 and A1 coded as At.f and we here allow a model
that depends on the randomization to be as adaptive as possible.</li>
<li>for the observational case one can here also adjust for
covarites.</li>
<li>Censoring model was stratified on A0.f</li>
</ul>
</div>
<div class="section level2">
<h2 id="causal-assumptions-for-twostage-randomization-recurrent-events">Causal assumptions for Twostage Randomization: Recurrent events<a class="anchor" aria-label="anchor" href="#causal-assumptions-for-twostage-randomization-recurrent-events"></a>
</h2>
<p>We take interest in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mn>1</mn></msub><annotation encoding="application/x-tex">N_1</annotation></semantics></math>
but also have death
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mi>d</mi></msub><annotation encoding="application/x-tex">N_d</annotation></semantics></math>.</p>
<p>Now we need that given
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mn>0</mn></msub><annotation encoding="application/x-tex">X_0</annotation></semantics></math></p>
<ul>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>0</mn></msub><mo>⊥</mo><msubsup><mi>N</mi><mn>1</mn><mn>0</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msubsup><mi>N</mi><mn>1</mn><mn>1</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msubsup><mi>N</mi><mi>d</mi><mn>0</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msubsup><mi>N</mi><mi>d</mi><mn>1</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="prefix">|</mo><msub><mi>X</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">A_0 \perp N_1^0(), N_1^1(), N_d^0(), N_d^1() | X_0</annotation></semantics></math></li>
<li>positivity
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>&gt;</mo><msub><mi>π</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">1 &gt; \pi_0(X_0) &gt; 0</annotation></semantics></math>
</li>
</ul>
<p>and given
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>X</mi><mo accent="true">‾</mo></mover><mn>1</mn></msub><annotation encoding="application/x-tex">\bar X_1</annotation></semantics></math>
the history accumulated at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>T</mi><mi>R</mi></msub><annotation encoding="application/x-tex">T_R</annotation></semantics></math>
of 2nd randomization</p>
<ul>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo>⊥</mo><msubsup><mi>N</mi><mn>1</mn><mn>0</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msubsup><mi>N</mi><mn>1</mn><mn>1</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msubsup><mi>N</mi><mi>d</mi><mn>0</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msubsup><mi>N</mi><mi>d</mi><mn>1</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="prefix">|</mo><msub><mover><mi>X</mi><mo accent="true">‾</mo></mover><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">A_1 \perp N_1^0(), N_1^1(), N_d^0(), N_d^1() | \bar X_1</annotation></semantics></math></li>
<li>positivity
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>&gt;</mo><msub><mi>π</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mn>1</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">1 &gt; \pi_1(X_1) &gt; 0</annotation></semantics></math>
</li>
</ul>
<p>and</p>
<ul>
<li>consistency</li>
</ul>
<p>to link the counterfactual quantities to observed data.</p>
<p>We must use IPTW weighted Cox score and augment as before</p>
<p>In addition we need that the censoring is independent given for
example
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mn>0</mn></msub><annotation encoding="application/x-tex">A_0</annotation></semantics></math></p>
<ul>
<li>Independent censoring</li>
</ul>
<p>To use the phreg_rct in this situation</p>
<ul>
<li>RCT=FALSE</li>
<li>propensity score models must be specified</li>
<li>marginal estimate is based on IPTW cox model phreg_IPTW
<ul>
<li>when the same model is used for the propensity scores and the
augmentation models the augmentation models are not needed due to the
adaptive nature from fitting the propensity score models.</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phreg_rct.html">phreg_rct</a></span><span class="op">(</span><span class="fu"><a href="../reference/Event.html">Event</a></span><span class="op">(</span><span class="va">start</span>,<span class="va">stop</span>,<span class="va">statusD</span><span class="op">)</span><span class="op">~</span><span class="va">Z.f</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,</span>
<span>     treat.var<span class="op">=</span><span class="st">"treattime"</span>,typesR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"non"</span>,<span class="st">"R0"</span><span class="op">)</span>,typesC<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"non"</span>,<span class="st">"C"</span>,<span class="st">"dynC"</span><span class="op">)</span>,</span>
<span>     RCT<span class="op">=</span><span class="cn">FALSE</span>,treat.model<span class="op">=</span><span class="va">Z.f</span><span class="op">~</span><span class="va">z1</span>,augmentR0<span class="op">=</span><span class="op">~</span><span class="va">z1</span>,augmentC<span class="op">=</span><span class="op">~</span><span class="va">z1</span><span class="op">+</span><span class="va">Count1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span>
<span><span class="co">#&gt;                Estimate    Std.Err       2.5%     97.5%      P-value</span></span>
<span><span class="co">#&gt; Marginal-Z.f1 0.3111195 0.08058494 0.15317593 0.4690631 0.0001130326</span></span>
<span><span class="co">#&gt; non_C:Z.f1    0.3067348 0.08057748 0.14880581 0.4646637 0.0001408301</span></span>
<span><span class="co">#&gt; non_dynC:Z.f1 0.2169383 0.07119837 0.07739205 0.3564845 0.0023117164</span></span>
<span><span class="co">#&gt; R0_non:Z.f1   0.3111195 0.08058494 0.15317593 0.4690631 0.0001130326</span></span>
<span><span class="co">#&gt; R0_C:Z.f1     0.3067348 0.08057748 0.14880581 0.4646637 0.0001408301</span></span>
<span><span class="co">#&gt; R0_dynC:Z.f1  0.2169383 0.07119837 0.07739205 0.3564845 0.0023117164</span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "summary.phreg_rct"</span></span></code></pre></div>
<p>and for twostage randomization</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phreg_rct.html">phreg_rct</a></span><span class="op">(</span><span class="fu"><a href="../reference/Event.html">Event</a></span><span class="op">(</span><span class="va">start</span>,<span class="va">time</span>,<span class="va">statusD</span><span class="op">)</span><span class="op">~</span><span class="va">A0.f</span><span class="op">+</span><span class="va">A1t</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>,data<span class="op">=</span><span class="va">rr</span>,</span>
<span>     typesR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"non"</span>,<span class="st">"R0"</span>,<span class="st">"R1"</span>,<span class="st">"R01"</span><span class="op">)</span>,typesC<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"non"</span>,<span class="st">"C"</span>,<span class="st">"dynC"</span><span class="op">)</span>,</span>
<span>     treat.var<span class="op">=</span><span class="st">"treattime"</span>,</span>
<span>     RCT<span class="op">=</span><span class="cn">FALSE</span>, treat.model<span class="op">=</span><span class="va">At.f</span><span class="op">~</span><span class="va">z1</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Count2</span><span class="op">)</span>,</span>
<span>     augmentR0<span class="op">=</span><span class="op">~</span><span class="va">z1</span>,augmentR1<span class="op">=</span><span class="op">~</span><span class="va">z1</span>,augmentC<span class="op">=</span><span class="op">~</span><span class="va">z1</span><span class="op">+</span><span class="va">Count1</span><span class="op">+</span><span class="va">A1t</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sse</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 Estimate    Std.Err        2.5%     97.5%      P-value</span></span>
<span><span class="co">#&gt; Marginal-A0.f1 0.3817476 0.13188068  0.12326622 0.6402290 0.0037958891</span></span>
<span><span class="co">#&gt; Marginal-A1t   0.2259319 0.12344157 -0.01600910 0.4678730 0.0672089296</span></span>
<span><span class="co">#&gt; non_C:A0.f1    0.3765255 0.12594711  0.12967369 0.6233773 0.0027938653</span></span>
<span><span class="co">#&gt; non_C:A1t      0.3187675 0.11256529  0.09814361 0.5393914 0.0046280182</span></span>
<span><span class="co">#&gt; non_dynC:A0.f1 0.3797091 0.11214290  0.15991306 0.5995051 0.0007093493</span></span>
<span><span class="co">#&gt; non_dynC:A1t   0.3514300 0.09297578  0.16920079 0.5336591 0.0001569535</span></span>
<span><span class="co">#&gt; R0_non:A0.f1   0.3817476 0.13188068  0.12326622 0.6402290 0.0037958891</span></span>
<span><span class="co">#&gt; R0_non:A1t     0.2259319 0.12344157 -0.01600910 0.4678730 0.0672089296</span></span>
<span><span class="co">#&gt; R0_C:A0.f1     0.3765255 0.12594711  0.12967369 0.6233773 0.0027938653</span></span>
<span><span class="co">#&gt; R0_C:A1t       0.3187675 0.11256529  0.09814361 0.5393914 0.0046280182</span></span>
<span><span class="co">#&gt; R0_dynC:A0.f1  0.3797091 0.11214290  0.15991306 0.5995051 0.0007093493</span></span>
<span><span class="co">#&gt; R0_dynC:A1t    0.3514300 0.09297578  0.16920079 0.5336591 0.0001569535</span></span>
<span><span class="co">#&gt; R1_non:A0.f1   0.3817476 0.13188068  0.12326622 0.6402290 0.0037958891</span></span>
<span><span class="co">#&gt; R1_non:A1t     0.2259319 0.12344157 -0.01600910 0.4678730 0.0672089296</span></span>
<span><span class="co">#&gt; R1_C:A0.f1     0.3765255 0.12594711  0.12967369 0.6233773 0.0027938653</span></span>
<span><span class="co">#&gt; R1_C:A1t       0.3187675 0.11256529  0.09814361 0.5393914 0.0046280182</span></span>
<span><span class="co">#&gt; R1_dynC:A0.f1  0.3797091 0.11214290  0.15991306 0.5995051 0.0007093493</span></span>
<span><span class="co">#&gt; R1_dynC:A1t    0.3514300 0.09297578  0.16920080 0.5336591 0.0001569535</span></span>
<span><span class="co">#&gt; R01_non:A0.f1  0.3817476 0.13185641  0.12331378 0.6401814 0.0037894525</span></span>
<span><span class="co">#&gt; R01_non:A1t    0.2259319 0.12307282 -0.01528637 0.4671502 0.0663934395</span></span>
<span><span class="co">#&gt; R01_C:A0.f1    0.3765255 0.12592170  0.12972349 0.6233275 0.0027883528</span></span>
<span><span class="co">#&gt; R01_C:A1t      0.3187675 0.11216079  0.09893641 0.5385986 0.0044823275</span></span>
<span><span class="co">#&gt; R01_dynC:A0.f1 0.3797091 0.11211436  0.15996900 0.5994492 0.0007071245</span></span>
<span><span class="co">#&gt; R01_dynC:A1t   0.3514300 0.09248564  0.17016144 0.5326985 0.0001447938</span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "summary.phreg_rct"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sessioninfo">SessionInfo<a class="anchor" aria-label="anchor" href="#sessioninfo"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.4.2 (2024-10-31)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 24.04.1 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] mets_1.3.5     timereg_2.0.6  survival_3.7-0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] cli_3.6.3           knitr_1.49          rlang_1.1.4        </span></span>
<span><span class="co">#&gt;  [4] xfun_0.50           textshaping_0.4.1   jsonlite_1.8.9     </span></span>
<span><span class="co">#&gt;  [7] listenv_0.9.1       future.apply_1.11.3 lava_1.8.0         </span></span>
<span><span class="co">#&gt; [10] htmltools_0.5.8.1   ragg_1.3.3          sass_0.4.9         </span></span>
<span><span class="co">#&gt; [13] rmarkdown_2.29      grid_4.4.2          evaluate_1.0.3     </span></span>
<span><span class="co">#&gt; [16] jquerylib_0.1.4     fastmap_1.2.0       mvtnorm_1.3-3      </span></span>
<span><span class="co">#&gt; [19] numDeriv_2016.8-1.1 yaml_2.3.10         lifecycle_1.0.4    </span></span>
<span><span class="co">#&gt; [22] compiler_4.4.2      codetools_0.2-20    fs_1.6.5           </span></span>
<span><span class="co">#&gt; [25] Rcpp_1.0.13-1       future_1.34.0       systemfonts_1.1.0  </span></span>
<span><span class="co">#&gt; [28] lattice_0.22-6      digest_0.6.37       R6_2.5.1           </span></span>
<span><span class="co">#&gt; [31] parallelly_1.41.0   parallel_4.4.2      splines_4.4.2      </span></span>
<span><span class="co">#&gt; [34] bslib_0.8.0         Matrix_1.7-1        tools_4.4.2        </span></span>
<span><span class="co">#&gt; [37] globals_0.16.3      pkgdown_2.1.1       cachem_1.1.0       </span></span>
<span><span class="co">#&gt; [40] desc_1.4.3</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Klaus K. Holst, Thomas Scheike.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
